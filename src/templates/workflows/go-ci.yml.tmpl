name: Go CI

on: push

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Docker
        uses: docker/setup-docker-action@v4
      - name: Set up Docker Compose
        uses: docker/setup-compose-action@v1
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24"
          cache: true
      - name: Create fake .env file
        run: |
          echo "API_KEY=test" > .env
          echo "DATABASE_URL=postgresql://postgres:postgres@localhost:5432/postgres?sslmode=disable" >> .env
      - name: Start dependencies
        run: docker compose up -d postgres
      - name: Wait for database
        run: |
          # Wait for database to be ready
          echo "Waiting for database to be ready..."
          timeout=60
          until docker compose exec -T postgres pg_isready 2>/dev/null || [ $timeout -le 0 ]; do
            echo "Waiting for database connection..."
            sleep 1
            timeout=$((timeout-1))
          done

          if [ $timeout -le 0 ]; then
            echo "Database connection timeout"
            exit 1
          fi

          echo "Database is ready!"
      - name: Install dependencies
        run: make install

      - name: Generate code
        run: make generate

      - name: Build
        run: go mod tidy && make build

      - name: Test
        run: make test
